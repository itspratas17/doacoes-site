<!DOCTYPE html>
<html lang="pt-PT">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Donations de Natal üéÑ</title>
<style>


</style>
</head>

<body>

<div id="snow"></div>
<div class="notification" id="notification"></div>

<div class="container">
</div>

<footer>
    <p class="footer-text">Feito de <span class="footer-heart">‚ù§Ô∏è</span> no esp√≠rito de Natal</p>
    <p class="footer-text">üéÑ Feliz Natal! üéÖ</p>
</footer>

<script>
/* =============================
   CONFIGURA√á√ÉO
============================= */
const GOAL = 1000;
const PAYPAL_EMAIL = 'matiaspratas18@gmail.com';
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTAdy0gTnG1SLoV6TQ3cwvm3wkX1hULhqfY7WEZsxQp8pVTJRKh2ceQv-QuUWiWbM_H0kkqhgVBrl5t/pub?output=csv';

/* =============================
   ELEMENTOS
============================= */
const progressBar = document.getElementById('progressBar');
const progressPercentage = document.getElementById('progressPercentage');
const totalAmount = document.getElementById('totalAmount');
const currentAmount = document.getElementById('currentAmount');
const donorCountEl = document.getElementById('donorCount');
const donorList = document.getElementById('donorList');
const notification = document.getElementById('notification');
const customAmountInput = document.getElementById('customAmount');

/* =============================
   ESTADO
============================= */
let totalDonated = 0;
let donorCount = 0;
let recentDonors = [];

/* =============================
   FUN√á√ïES AUXILIARES
============================= */

// Converte datas do Google Sheets com seguran√ßa
function parseSheetDate(dateStr) {
    if (!dateStr) return null;

    // tenta direto (ISO ou timestamp)
    let d = new Date(dateStr);
    if (!isNaN(d.getTime())) return d;

    // formato dd/mm/yyyy hh:mm
    const parts = dateStr.split(' ');
    const date = parts[0]?.split('/');
    const time = (parts[1] || '00:00').split(':');

    if (!date || date.length !== 3) return null;

    return new Date(
        Number(date[2]),
        Number(date[1]) - 1,
        Number(date[0]),
        Number(time[0]),
        Number(time[1]) || 0
    );
}

function timeAgo(date) {
    if (!date) return 'Recentemente';

    const now = new Date();
    const diff = now - date;

    if (diff < 0) return 'Recentemente';

    const min = Math.floor(diff / 60000);
    const hour = Math.floor(diff / 3600000);
    const day = Math.floor(diff / 86400000);

    if (min < 1) return 'Agora mesmo';
    if (min < 60) return `H√° ${min} min`;
    if (hour < 24) return `H√° ${hour} horas`;
    if (day === 1) return 'H√° 1 dia';
    return `H√° ${day} dias`;
}

/* =============================
   CARREGAR DADOS
============================= */
function loadDataFromSheet() {
    fetch(SHEET_URL)
        .then(r => r.text())
        .then(csv => {
            const rows = csv.trim().split('\n').slice(1);

            totalDonated = 0;
            donorCount = 0;
            recentDonors = [];

            rows.forEach(row => {
                const cols = row.split(',').map(c => c.trim());
                const name = cols[0] || 'Doador An√≥nimo';
                const amount = parseFloat(cols[1]);
                const dateStr = cols[2];

                if (!amount || amount <= 0) return;

                const donationDate = parseSheetDate(dateStr);

                totalDonated += amount;
                donorCount++;

                recentDonors.push({
                    name,
                    amount,
                    time: timeAgo(donationDate)
                });
            });

            recentDonors.reverse();
            recentDonors = recentDonors.slice(0, 10);

            updateUI();
        })
        .catch(() => {
            donorList.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">Erro ao carregar dados</div>';
        });
}

/* =============================
   UI
============================= */
function updateUI() {
    const percentage = Math.min((totalDonated / GOAL) * 100, 100);

    progressBar.style.width = percentage + '%';
    progressPercentage.textContent = Math.round(percentage) + '%';

    totalAmount.textContent = '‚Ç¨' + totalDonated.toFixed(2);
    currentAmount.textContent = '‚Ç¨' + totalDonated.toFixed(2);
    donorCountEl.textContent = donorCount;

    if (totalDonated > GOAL) {
        progressPercentage.textContent = '100% + ‚Ç¨' + (totalDonated - GOAL).toFixed(2);
    }

    updateDonorList();
}

function updateDonorList() {
    if (!recentDonors.length) {
        donorList.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">Seja o primeiro a doar! üéÖ</div>';
        return;
    }

    donorList.innerHTML = recentDonors.map(d => `
        <div class="donor-item">
            <div>
                <div class="donor-name">üéÅ ${d.name}</div>
                <div class="donor-time">${d.time}</div>
            </div>
            <div class="donor-amount">‚Ç¨${d.amount.toFixed(2)}</div>
        </div>
    `).join('');
}

/* =============================
   PAYPAL
============================= */
function redirectToPayPal(amount) {
    showNotification(`üéÅ A redirecionar para PayPal (‚Ç¨${amount.toFixed(2)})...`);
    const url = `https://www.paypal.com/donate/?business=${encodeURIComponent(PAYPAL_EMAIL)}&amount=${amount}&currency_code=EUR`;
    setTimeout(() => window.open(url, '_blank'), 1000);
}

function makeDonation(amount) {
    redirectToPayPal(amount);
}

function makeCustomDonation() {
    const amount = parseFloat(customAmountInput.value);
    if (!amount || amount <= 0) {
        showNotification('‚ö†Ô∏è Valor inv√°lido');
        return;
    }
    redirectToPayPal(amount);
    customAmountInput.value = '';
}

/* =============================
   NOTIFICA√á√ÉO
============================= */
function showNotification(msg) {
    notification.textContent = msg;
    notification.classList.add('show');
    setTimeout(() => notification.classList.remove('show'), 3000);
}

/* =============================
   INIT
============================= */
loadDataFromSheet();
setInterval(loadDataFromSheet, 30000);
</script>

</body>
</html>

